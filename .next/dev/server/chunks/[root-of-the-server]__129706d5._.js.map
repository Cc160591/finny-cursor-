{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/christiancoli/finny-web/src/app/api/chat/route.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\nimport { NextResponse } from \"next/server\";\nimport OpenAI from \"openai\";\nimport fs from \"fs\";\nimport path from \"path\";\n\nconst LOG_PATH = \"/Users/christiancoli/finny-web/.cursor/debug.log\";\n\nfunction logToFile(payload: any) {\n  try {\n    const logDir = path.dirname(LOG_PATH);\n    if (!fs.existsSync(logDir)) fs.mkdirSync(logDir, { recursive: true });\n    fs.appendFileSync(LOG_PATH, JSON.stringify(payload) + \"\\n\");\n  } catch (e) {}\n}\n\nexport async function POST(req: Request) {\n  try {\n// #region agent log\nconst log1 = {location:'api/chat/route.ts:18',message:'API Route Entry',data:{hasSupabaseUrl:!!process.env.SUPABASE_URL,hasServiceKey:!!process.env.SUPABASE_SERVICE_ROLE_KEY,hasOpenaiKey:!!process.env.OPENAI_API_KEY},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'2'};\nlogToFile(log1);\nfetch('http://127.0.0.1:7244/ingest/96758caa-5fa3-4088-b7e9-c48caeafa71c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(log1)}).catch(()=>{});\n// #endregion\n    // 1. Validazione Variabili d'Ambiente\n    const supabaseUrl = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL;\n    const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n    const openaiApiKey = process.env.OPENAI_API_KEY;\n\n    if (!supabaseUrl || !supabaseServiceKey || !openaiApiKey) {\n      console.error(\"Missing environment variables\", {\n        hasUrl: !!supabaseUrl,\n        hasServiceKey: !!supabaseServiceKey,\n        hasOpenaiKey: !!openaiApiKey,\n      });\n      return NextResponse.json(\n        { error: \"Configurazione server incompleta (variabili d'ambiente mancanti)\" },\n        { status: 500 }\n      );\n    }\n\n    // 2. Inizializzazione Client\n    const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey);\n    const openai = new OpenAI({ apiKey: openaiApiKey });\n\n    // 3. Verifica Autenticazione Utente\n    const authHeader = req.headers.get(\"Authorization\");\n    if (!authHeader) {\n      return NextResponse.json({ error: \"Token di autorizzazione mancante\" }, { status: 401 });\n    }\n\n    const token = authHeader.replace(\"Bearer \", \"\");\n// #region agent log\nconst log2 = {location:'api/chat/route.ts:40',message:'Auth Token Check',data:{tokenPreview:token.substring(0,10)+'...'},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'3'};\nlogToFile(log2);\nfetch('http://127.0.0.1:7244/ingest/96758caa-5fa3-4088-b7e9-c48caeafa71c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(log2)}).catch(()=>{});\n// #endregion\n    const { data: { user }, error: authError } = await supabaseAdmin.auth.getUser(token);\n\n    if (authError || !user) {\n// #region agent log\nconst log3 = {location:'api/chat/route.ts:45',message:'Auth Failed',data:{error:authError},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'3'};\nlogToFile(log3);\nfetch('http://127.0.0.1:7244/ingest/96758caa-5fa3-4088-b7e9-c48caeafa71c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(log3)}).catch(()=>{});\n// #endregion\n      console.error(\"Auth error:\", authError);\n      return NextResponse.json({ error: \"Sessione non valida o scaduta\" }, { status: 401 });\n    }\n\n    // 4. Lettura Body\n    const { message, history = [] } = await req.json();\n    if (!message) {\n      return NextResponse.json({ error: \"Messaggio mancante\" }, { status: 400 });\n    }\n\n    // 5. Fetch transazioni recenti (context per AI)\n    const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();\n    const { data: recentTransactions } = await supabaseAdmin\n      .from(\"transactions\")\n      .select(\"merchant, amount_cents, occurred_at\")\n      .eq(\"user_id\", user.id)\n      .gte(\"occurred_at\", sevenDaysAgo);\n\n    const pizzaCount = recentTransactions?.filter(t => \n      t.merchant?.toLowerCase().includes(\"pizza\")\n    ).length || 0;\n\n    const systemPrompt = `\n      Sei Finny, un coach finanziario personale ironico e smart.\n      Il tuo compito è aiutare l'utente a gestire le sue finanze.\n      \n      CONTEXT:\n      - Utente: ${user.email}\n      - Pizze mangiate negli ultimi 7 giorni: ${pizzaCount}\n      \n      REGOLE:\n      1. Se l'utente descrive una spesa o un'entrata, DEVI estrarre i dati.\n      2. Sii ironico se l'utente spende troppo in cose superflue (es: pizza, drink).\n      3. Se l'utente ha mangiato 5 o più pizze in una settimana, faglielo notare con sarcasmo.\n      4. Rispondi sempre in italiano, in modo colloquiale ma professionale.\n      \n      FORMATO RISPOSTA (JSON STRICT):\n      {\n        \"assistant_message\": \"Testo della tua risposta ironica\",\n        \"actions\": [\n          {\n            \"type\": \"create_transaction\",\n            \"data\": {\n              \"type\": \"expense\" | \"income\",\n              \"amount_cents\": number,\n              \"merchant\": \"string\",\n              \"notes\": \"string\"\n            }\n          }\n        ]\n      }\n    `;\n\n    // 6. Chiamata OpenAI\n// #region agent log\nconst log4 = {location:'api/chat/route.ts:98',message:'OpenAI Call Start',data:{model:'gpt-4o-mini'},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'5'};\nlogToFile(log4);\nfetch('http://127.0.0.1:7244/ingest/96758caa-5fa3-4088-b7e9-c48caeafa71c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(log4)}).catch(()=>{});\n// #endregion\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        ...history.slice(-10).map((m: any) => ({\n          role: m.role,\n          content: m.content\n        })),\n        { role: \"user\", content: message }\n      ],\n      response_format: { type: \"json_object\" }\n    });\n\n    const aiResult = JSON.parse(response.choices[0].message.content || \"{}\");\n\n// #region agent log\nconst log5 = {location:'api/chat/route.ts:114',message:'OpenAI Call Success',data:{aiMessage:aiResult.assistant_message},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'5'};\nlogToFile(log5);\nfetch('http://127.0.0.1:7244/ingest/96758caa-5fa3-4088-b7e9-c48caeafa71c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(log5)}).catch(()=>{});\n// #endregion\n\n    // 7. Persistenza messaggi\n    await supabaseAdmin\n      .from(\"chat_messages\")\n      .insert({ user_id: user.id, role: \"user\", content: message });\n\n    const { data: assistantMsg } = await supabaseAdmin\n      .from(\"chat_messages\")\n      .insert({ user_id: user.id, role: \"assistant\", content: aiResult.assistant_message })\n      .select()\n      .single();\n\n    // 8. Esecuzione azioni estratte\n    if (aiResult.actions) {\n      for (const action of aiResult.actions) {\n        if (action.type === \"create_transaction\") {\n          await supabaseAdmin.from(\"transactions\").insert({\n            user_id: user.id,\n            type: action.data.type,\n            amount_cents: action.data.amount_cents,\n            merchant: action.data.merchant,\n            notes: action.data.notes,\n            message_id: assistantMsg?.id\n          });\n        }\n      }\n    }\n\n    return NextResponse.json(aiResult);\n\n  } catch (error: any) {\n    console.error(\"AI Route Error:\", error);\n    return NextResponse.json(\n      { error: \"Errore interno del server\", details: error.message },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}