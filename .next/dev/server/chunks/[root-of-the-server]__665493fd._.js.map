{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/christiancoli/finny-web/src/app/api/chat/route.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\nimport { NextResponse } from \"next/server\";\nimport OpenAI from \"openai\";\n\n// Configurazione OpenAI\nconst openai = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY,\n});\n\n// Client Supabase con Service Role (per bypassare RLS e scrivere logica di sistema)\nconst supabaseAdmin = createClient(\n  process.env.SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\nexport async function POST(req: Request) {\n  try {\n    const authHeader = req.headers.get(\"Authorization\");\n    if (!authHeader) return NextResponse.json({ error: \"No token\" }, { status: 401 });\n\n    const token = authHeader.replace(\"Bearer \", \"\");\n    \n    // Verifica utente\n    const { data: { user }, error: authError } = await supabaseAdmin.auth.getUser(token);\n    if (authError || !user) return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n\n    const { message, history = [] } = await req.json();\n\n    // 1. Fetch recent pizza transactions to check for the \"too many pizzas\" rule\n    const { data: recentTransactions } = await supabaseAdmin\n      .from(\"transactions\")\n      .select(\"merchant, amount_cents, occurred_at\")\n      .eq(\"user_id\", user.id)\n      .gte(\"occurred_at\", new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString());\n\n    const pizzaCount = recentTransactions?.filter(t => t.merchant?.toLowerCase().includes(\"pizza\")).length || 0;\n\n    const systemPrompt = `\n      Sei Finny, un coach finanziario personale ironico e smart.\n      Il tuo compito è aiutare l'utente a gestire le sue finanze.\n      \n      CONTEXT:\n      - Utente: ${user.email}\n      - Pizze mangiate negli ultimi 7 giorni: ${pizzaCount}\n      \n      REGOLE:\n      1. Se l'utente descrive una spesa o un'entrata, DEVI estrarre i dati.\n      2. Sii ironico se l'utente spende troppo in cose superflue (es: pizza, drink).\n      3. Se l'utente ha mangiato 5 o più pizze in una settimana, faglielo notare con sarcasmo.\n      4. Rispondi sempre in italiano, in modo colloquiale ma professionale.\n      \n      FORMATO RISPOSTA (JSON STRICT):\n      {\n        \"assistant_message\": \"Testo della tua risposta ironica\",\n        \"actions\": [\n          {\n            \"type\": \"create_transaction\",\n            \"data\": {\n              \"type\": \"expense\" | \"income\",\n              \"amount_cents\": number,\n              \"merchant\": \"string\",\n              \"notes\": \"string\"\n            }\n          }\n        ]\n      }\n    `;\n\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        ...history.slice(-10),\n        { role: \"user\", content: message }\n      ],\n      response_format: { type: \"json_object\" }\n    });\n\n    const aiResult = JSON.parse(response.choices[0].message.content || \"{}\");\n\n    // 2. Persistenza su Supabase\n    const { data: userMsg } = await supabaseAdmin\n      .from(\"chat_messages\")\n      .insert({ user_id: user.id, role: \"user\", content: message })\n      .select()\n      .single();\n\n    const { data: assistantMsg } = await supabaseAdmin\n      .from(\"chat_messages\")\n      .insert({ user_id: user.id, role: \"assistant\", content: aiResult.assistant_message })\n      .select()\n      .single();\n\n    // 3. Esegui azioni (es: crea transazione)\n    if (aiResult.actions) {\n      for (const action of aiResult.actions) {\n        if (action.type === \"create_transaction\") {\n          await supabaseAdmin.from(\"transactions\").insert({\n            user_id: user.id,\n            type: action.data.type,\n            amount_cents: action.data.amount_cents,\n            merchant: action.data.merchant,\n            notes: action.data.notes,\n            message_id: assistantMsg?.id\n          });\n        }\n      }\n    }\n\n    return NextResponse.json(aiResult);\n\n  } catch (error: any) {\n    console.error(error);\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}